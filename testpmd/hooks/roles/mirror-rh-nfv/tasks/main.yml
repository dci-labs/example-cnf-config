---
- name: "Mirror index image"
  shell:
    cmd: >
      skopeo copy 
      --all
      --authfile {{ mrn_pull_secret }}
      --dest-tls-verify=false
      --remove-signatures
      docker://{{ mrn_index_image }}
      docker://{{ mrn_mirror_index_image }}
  register: copy
  retries: 5
  delay: 5
  until:
    - copy is not failed

- name: "Create temp manifest dir"
  tempfile:
    state: directory
  register: mrn_manifest_dir

- name: "Mirror images from index"
  shell:
    cmd: >
      {{ oc_tool_path }} adm catalog mirror
      -a {{ mrn_pull_secret }}
      --to-manifests={{ mrn_manifest_dir.path }}
      {{ mrn_mirror_index_image }}
      {{ mrn_local_registry }}

- name: Add index image into ImageContentSourcePolicy
  blockinfile:
    path: "{{ mrn_manifest_dir.path }}/imageContentSourcePolicy.yaml"
    state: present
    marker: ""
    block: |2
        - mirrors:
          - {{ mrn_mirror_index_image | regex_replace(':[^/]+$') }}
          source: {{ mrn_index_image | regex_replace(':[^/]+$') }}

- name: "Apply ImageContentSourcePolicy"
  k8s:
    src: "{{ mrn_manifest_dir.path }}/imageContentSourcePolicy.yaml"
  notify: "Delete temporary directories"

- name:  Wait for MCP status
  include_role:
    name: check-resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: 60
    check_wait_delay: 60
    check_reason: "ICSP update in mirror-rh-nfv"
...
